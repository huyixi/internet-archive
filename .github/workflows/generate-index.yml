name: Generate index.html

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  generate-index:
    runs-on: ubuntu-latest

    steps:
      - name: Check out the repository
        uses: actions/checkout@v3

      - name: Generate index.html
        run: |
          repo_dir=$(pwd)
          output_file="$repo_dir/index.html"
          cat << 'EOF' > $output_file
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>huyixi's Internet Archive</title>
    <link rel="stylesheet" href="css/index.min.css">
</head>
<body>
    <h1>huyixi's Internet Archive</h1>
    <ul>
EOF

          temp_file=$(mktemp)

          find $repo_dir -type f -name "*.html" ! -name "index.html" | while read file; do
            rel_path=$(realpath --relative-to="$repo_dir" "$file")

            html_comment=$(perl -0777 -ne 'print $& if /<!--[\s\S]*?-->/g' "$file")

            # Extract metadata
            title=$(echo "$html_comment" | perl -ne 'print $1 if /title: (.*?)(?:\n|$)/i')
            author=$(echo "$html_comment" | perl -ne 'print $1 if /author: (.*?)(?:\n|$)/i')
            date_from_file=$(echo "$html_comment" | perl -ne 'print $1 if /date: (\d{4}-\d{2}-\d{2})/i')

            if [ ! -z "$date_from_file" ]; then
              timestamp=$(date -d "$date_from_file" +%s)
            else
              timestamp=0
            fi

            echo "$timestamp|$rel_path|$date_from_file|$title|$author" >> $temp_file
          done

          # Sort by timestamp (newest first) and generate HTML links
          sort -rn $temp_file | while IFS='|' read -r timestamp path date title author; do
            echo -n "<li>" >> $output_file

            if [ ! -z "$title" ]; then
              echo -n "<a href=\"$path\">$title</a>" >> $output_file
              if [ ! -z "$author" ] || [ ! -z "$date" ]; then
                echo -n "," >> $output_file
              fi
            else
              filename=$(basename "$path" .html)
              display_filename=$(echo "$filename" | cut -d'_' -f1)
              echo -n "<a href=\"$path\">$display_filename</a>" >> $output_file
              if [ ! -z "$author" ] || [ ! -z "$date" ]; then
                echo -n "," >> $output_file
              fi
            fi

            if [ ! -z "$author" ]; then
              echo -n " <span class=\"author\">$author</span>" >> $output_file
              if [ ! -z "$date" ]; then
                echo -n "," >> $output_file
              fi
            fi

            if [ ! -z "$date" ]; then
              echo -n " <span class=\"date\">$date</span>" >> $output_file
            fi

            echo "</li>" >> $output_file
          done

          # Clean up temporary file
          rm $temp_file

          echo "</ul>" >> $output_file
          echo "</body></html>" >> $output_file

      - name: Commit and push changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          if [ -n "$(git status --porcelain)" ]; then
            git add index.html
            git commit -m "Update index.html with new HTML files"
            git push
          else
            echo "No changes to commit"
          fi
